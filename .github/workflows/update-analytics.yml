name: Update Energy Analytics

on:
  schedule:
    # Run daily at 1:30 AM UTC
    - cron: '30 1 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create necessary directories and credentials
      run: |
        pwd
        ls -la
        # Create required directories
        mkdir -p App/Data
        mkdir -p docs
        # Create credentials file
        echo "OPENELECTRICITY_API_KEY=${{ secrets.OPENELECTRICITY_API_KEY }}" > App/credentials.txt
        echo "API_KEY=${{ secrets.OPENELECTRICITY_API_KEY }}" >> App/credentials.txt
        echo "📁 Directory structure created"
        
    - name: Set environment variables and verify API key
      run: |
        echo "OPENELECTRICITY_API_KEY=${{ secrets.OPENELECTRICITY_API_KEY }}" >> $GITHUB_ENV
        echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV
        echo "🔑 API key verification:"
        if [ -n "${{ secrets.OPENELECTRICITY_API_KEY }}" ]; then
          echo "✅ API key secret is available"
        else
          echo "❌ API key secret is missing"
        fi
        
    - name: Run analytics update
      env:
        OPENELECTRICITY_API_KEY: ${{ secrets.OPENELECTRICITY_API_KEY }}
      run: |
        echo "🔍 Checking App/src/ contents:"
        ls -la App/src/ || echo "App/src/ not found"
        echo "🔍 Current directory contents:"
        ls -la
        echo "🔍 Environment check:"
        echo "API key is set: $(if [ -n "$OPENELECTRICITY_API_KEY" ]; then echo 'YES'; else echo 'NO'; fi)"
        echo "🚀 Running energy analytics..."
        cd App/src
        python app.py
        echo "✅ Analytics completed - checking output..."
        cd ../../
        ls -la docs/ || echo "❌ docs/ folder not found after execution"
        
    - name: Verify generated files
      run: |
        echo "Checking docs/ contents:"
        ls -la docs/
        echo "✅ Verification completed"
        
    - name: Commit and push if changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check what files exist
        echo "📂 Files before git add:"
        ls -la App/Data/ || echo "No App/Data/"
        ls -la docs/ || echo "No docs/"
        
        # Add files that exist
        git add -A
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          echo "📝 Committing changes..."
          git commit -m "🔄 Update energy analytics data and dashboard - $(date '+%Y-%m-%d %H:%M UTC')"
          git push
          echo "✅ Changes pushed successfully"
        fi
        
    - name: Deploy to GitHub Pages (Simple)
      run: |
        # Final verification of docs folder
        echo "Files ready for GitHub Pages:"
        ls -la docs/
        echo "✅ Deployment ready"