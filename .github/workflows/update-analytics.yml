name: Update Energy Analytics

on:
  schedule:
    # Run daily at 2:30 AM UTC
    - cron: '35 2 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [ main ]

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: 🧭 Checkout repository
      uses: actions/checkout@v4

    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: ⚡ Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 🗂️ Create directories
      run: |
        mkdir -p App/Data
        mkdir -p docs
        echo "📁 Directory structure ready"

    - name: 🔐 Set environment variables
      run: |
        echo "OPENELECTRICITY_API_KEY=${{ secrets.OPENELECTRICITY_API_KEY }}" >> $GITHUB_ENV
        echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV
        if [ -n "${{ secrets.OPENELECTRICITY_API_KEY }}" ]; then
          echo "✅ API key secret available"
        else
          echo "❌ API key secret missing"; exit 1;
        fi

    - name: 🚀 Run analytics update
      env:
        OPENELECTRICITY_API_KEY: ${{ secrets.OPENELECTRICITY_API_KEY }}
      run: |
        echo "🔍 Checking App/src/"
        ls -la App/src/ || echo "App/src/ not found"
        cd App/src
        echo "🚀 Running analytics script..."
        python app.py || { echo "❌ app.py execution failed"; exit 1; }
        cd ../../
        echo "✅ Analytics completed"
        ls -la docs/ || echo "❌ docs folder not found"

    - name: ✅ Verify generated output
      run: |
        if [ ! -d "docs" ] || [ -z "$(ls -A docs 2>/dev/null)" ]; then
          echo "❌ No files generated in docs/"
          exit 1
        else
          echo "✅ Files successfully generated:"
          ls -la docs/
        fi

    - name: 💾 Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add files and directories that exist
        [ -d "App/Data" ] && git add App/Data/ || echo "App/Data/ not found"
        [ -d "docs" ] && git add docs/ || echo "docs/ not found"
        
        if git diff --staged --quiet; then
          echo "📝 No changes to commit"
        else
          git commit -m "🤖 Auto-update: Energy analytics $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "✅ Changes committed and pushed"
        fi

    - name: 📤 Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/

    - name: 🚀 Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
